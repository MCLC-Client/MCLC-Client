<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCLC - Admin Dashboard</title>
    <link rel="icon" type="image/png" href="resources/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1bd96a',
                        'primary-dark': '#14a34f',
                        surface: '#121212',
                        background: '#080808',
                        'accent-dark': '#0f0f0f',
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>

<body class="bg-background text-gray-200 selection:bg-primary/30 antialiased">

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 right-0 z-[100] transition-all duration-300 bg-background/80 backdrop-blur-md border-b border-white/5"
        id="navbar">
        <div class="max-w-7xl mx-auto px-6 lg:px-12 flex items-center justify-between h-20">
            <a href="index.html" class="flex items-center gap-3">
                <img src="resources/icon.png" alt="MCLC Logo" class="w-10 h-10 object-contain">
                <span class="text-2xl font-extrabold tracking-tighter text-white">MCLC Admin</span>
            </a>

            <div class="flex items-center gap-4" id="nav-right-group">
                <a id="downloadNavBtn" href="#"
                    class="bg-primary hover:bg-primary-dark text-black px-6 py-2.5 rounded-xl font-bold transition-all shadow-primary-glow transform hover:scale-105 active:scale-95 shrink-0">
                    Download
                </a>
            </div>
        </div>
    </nav>

    <div class="pt-32 pb-20 px-6 max-w-7xl mx-auto">
        <div class="flex items-center justify-between mb-12">
            <h1 class="text-4xl font-black text-white">Extensions Admin</h1>
            <div class="flex bg-surface/50 p-1 rounded-2xl border border-white/5">
                <button onclick="switchTab('approvals')" id="tab-btn-approvals"
                    class="px-6 py-2.5 rounded-xl font-bold transition-all bg-primary text-black">Approvals</button>
                <button onclick="switchTab('manage')" id="tab-btn-manage"
                    class="px-6 py-2.5 rounded-xl font-bold transition-all text-gray-400 hover:text-white">Management</button>
            </div>
        </div>

        <!-- Approvals Tab -->
        <div id="view-approvals" class="space-y-6">
            <h2 class="text-xl font-bold text-gray-400 mb-6 uppercase tracking-widest">Pending Review</h2>
            <div id="pending-list" class="space-y-6">
                <div class="text-gray-500 animate-pulse">Loading pending extensions...</div>
            </div>
        </div>

        <!-- Management Tab -->
        <div id="view-manage" class="hidden space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
                <h2 class="text-xl font-bold text-gray-400 uppercase tracking-widest">Global Extension List</h2>
                <div class="relative w-full md:w-96">
                    <input type="text" id="admin-search" placeholder="Search extensions..."
                        class="w-full bg-surface/50 border border-white/5 rounded-2xl px-6 py-4 focus:border-primary/50 outline-none text-white transition-all shadow-inner"
                        oninput="filterExtensions()">
                    <svg class="w-5 h-5 absolute right-6 top-1/2 -translate-y-1/2 text-gray-500" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2" stroke-linecap="round" />
                    </svg>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-4" id="all-extensions-list">
                <!-- List will be populated by JS -->
            </div>
        </div>
    </div>

    <script>
        let allExtensions = [];

        function switchTab(tab) {
            document.getElementById('view-approvals').classList.toggle('hidden', tab !== 'approvals');
            document.getElementById('view-manage').classList.toggle('hidden', tab !== 'manage');

            document.getElementById('tab-btn-approvals').className = tab === 'approvals'
                ? 'px-6 py-2.5 rounded-xl font-bold transition-all bg-primary text-black'
                : 'px-6 py-2.5 rounded-xl font-bold transition-all text-gray-400 hover:text-white';

            document.getElementById('tab-btn-manage').className = tab === 'manage'
                ? 'px-6 py-2.5 rounded-xl font-bold transition-all bg-primary text-black'
                : 'px-6 py-2.5 rounded-xl font-bold transition-all text-gray-400 hover:text-white';

            if (tab === 'manage') loadAllExtensions();
            else loadPending();
        }

        async function loadPending() {
            const list = document.getElementById('pending-list');
            list.innerHTML = '<div class="text-gray-500 animate-pulse">Loading pending items...</div>';

            try {
                const [extRes, verRes, draftRes] = await Promise.all([
                    fetch('/api/admin/extensions/pending'),
                    fetch('/api/admin/versions/pending'),
                    fetch('/api/admin/drafts/pending')
                ]);

                if (extRes.status === 403 || extRes.status === 401) {
                    alert('Access Denied: Admins Only');
                    window.location.href = '/';
                    return;
                }

                const extensions = await extRes.json();
                const versions = await verRes.json();
                const drafts = await draftRes.json();

                if (!Array.isArray(extensions) || !Array.isArray(versions) || !Array.isArray(drafts)) {
                    list.innerHTML = '<div class="bg-surface/30 border border-dashed border-white/5 p-12 rounded-2xl text-center text-gray-500 font-bold">Invalid response format from server.</div>';
                    return;
                }

                if (extensions.length === 0 && versions.length === 0 && drafts.length === 0) {
                    list.innerHTML = '<div class="bg-surface/30 border border-dashed border-white/5 p-12 rounded-2xl text-center text-gray-600 font-bold">No pending items.</div>';
                    return;
                }

                let html = '';

                // 1. Pending Extensions (New Projects)
                if (extensions.length > 0) {
                    html += `<h3 class="text-lg font-bold text-primary mb-4 uppercase tracking-widest">New Projects</h3>`;
                    html += extensions.map(ext => `
                        <div class="bg-surface border border-white/5 p-8 rounded-2xl flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6 transition-all hover:border-primary/20 mb-6">
                            <div class="flex-1">
                                <h3 class="font-bold text-white text-2xl mb-1">${ext.name}</h3>
                                <div class="flex items-center gap-2 mb-4">
                                    <span class="text-[10px] font-bold text-primary uppercase tracking-wider bg-primary/10 border border-primary/20 px-2 py-1 rounded">ID: ${ext.identifier}</span>
                                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider bg-white/5 border border-white/10 px-2 py-1 rounded">New Extension</span>
                                </div>
                                <p class="text-white font-semibold mb-2">${ext.summary || ''}</p>
                                <p class="text-gray-400 mb-6 text-sm whitespace-pre-wrap line-clamp-3">${ext.description}</p>
                                <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500 bg-black/20 p-4 rounded-xl">
                                    <span>By: <span class="text-white font-bold">${ext.developer}</span></span>
                                </div>
                                <div class="mt-4 flex items-center gap-4">
                                    <a href="/uploads/${ext.file_path}" download class="text-primary hover:underline flex items-center gap-2 text-sm font-bold">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                        Download File for Review
                                    </a>
                                </div>
                            </div>
                            <div class="flex lg:flex-col items-center gap-3 shrink-0 w-full lg:w-48">
                                <button onclick="updateExtensionStatus(${ext.id}, 'approve')" 
                                    class="w-full bg-primary hover:bg-primary-dark text-black px-6 py-4 rounded-xl font-bold transition-all shadow-primary-glow">Approve</button>
                                <button onclick="updateExtensionStatus(${ext.id}, 'action_required')" 
                                    class="w-full bg-yellow-500 hover:bg-yellow-600 text-black px-6 py-4 rounded-xl font-bold transition-all">Action Required</button>
                                <button onclick="updateExtensionStatus(${ext.id}, 'reject')" 
                                    class="w-full bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white border border-red-500/20 px-6 py-4 rounded-xl font-bold transition-all">Reject</button>
                            </div>
                        </div>
                    `).join('');
                }

                // 2. Pending Versions (Updates)
                if (versions.length > 0) {
                    html += `<h3 class="text-lg font-bold text-blue-400 mb-4 uppercase tracking-widest mt-8">Pending Updates</h3>`;
                    html += versions.map(v => `
                        <div class="bg-surface border border-white/5 p-8 rounded-2xl flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6 transition-all hover:border-blue-400/20 mb-6">
                            <div class="flex-1">
                                <h3 class="font-bold text-white text-2xl mb-1">${v.extension_name} <span class="text-gray-500 text-lg">v${v.version}</span></h3>
                                <div class="flex items-center gap-2 mb-4">
                                    <span class="text-[10px] font-bold text-blue-400 uppercase tracking-wider bg-blue-400/10 border border-blue-400/20 px-2 py-1 rounded">Update</span>
                                    <span class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">By ${v.developer}</span>
                                </div>
                                <div class="bg-black/30 p-4 rounded-xl mb-4 border border-white/5">
                                    <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Changelog</p>
                                    <p class="text-gray-300 text-sm whitespace-pre-wrap">${v.changelog}</p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <a href="${v.file_path}" download class="text-blue-400 hover:underline flex items-center gap-2 text-sm font-bold">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                        Download File
                                    </a>
                                </div>
                            </div>
                            <div class="flex lg:flex-col items-center gap-3 shrink-0 w-full lg:w-48">
                                <button onclick="updateVersionStatus(${v.id}, 'approve')" 
                                    class="w-full bg-blue-500 hover:bg-blue-600 text-white px-6 py-4 rounded-xl font-bold transition-all shadow-lg shadow-blue-500/20">Approve</button>
                                <button onclick="updateVersionStatus(${v.id}, 'reject')" 
                                    class="w-full bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white border border-red-500/20 px-6 py-4 rounded-xl font-bold transition-all">Reject</button>
                            </div>
                        </div>
                    `).join('');
                }

                // 3. Pending Drafts (Metadata)
                if (drafts.length > 0) {
                    html += `<h3 class="text-lg font-bold text-yellow-500 mb-4 uppercase tracking-widest mt-8">Metadata Changes</h3>`;
                    html += drafts.map(d => `
                        <div class="bg-surface border border-white/5 p-8 rounded-2xl flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6 transition-all hover:border-yellow-500/20 mb-6">
                            <div class="flex-1">
                                <h3 class="font-bold text-white text-2xl mb-1">${d.original_name}</h3>
                                <div class="flex items-center gap-2 mb-4">
                                    <span class="text-[10px] font-bold text-yellow-500 uppercase tracking-wider bg-yellow-500/10 border border-yellow-500/20 px-2 py-1 rounded">Metadata Edit</span>
                                    <span class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">By ${d.developer}</span>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    ${d.name ? `<div class="bg-white/5 p-3 rounded-lg"><span class="block text-[10px] text-gray-500 uppercase">New Name</span><span class="text-white">${d.name}</span></div>` : ''}
                                    ${d.summary ? `<div class="bg-white/5 p-3 rounded-lg"><span class="block text-[10px] text-gray-500 uppercase">New Summary</span><span class="text-white">${d.summary}</span></div>` : ''}
                                </div>
                                ${d.description ? `<div class="mt-4 bg-black/30 p-4 rounded-xl border border-white/5"><p class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">New Description</p><p class="text-gray-400 text-xs line-clamp-3 italic">Changed (too long to show full diff)</p></div>` : ''}
                                ${d.banner_path ? `<div class="mt-4"><p class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">New Banner</p><img src="/uploads/${d.banner_path}" class="w-48 h-24 object-cover rounded-lg border border-white/10"></div>` : ''}
                            </div>
                            <div class="flex lg:flex-col items-center gap-3 shrink-0 w-full lg:w-48">
                                <button onclick="updateDraftStatus(${d.id}, 'approve')" 
                                    class="w-full bg-yellow-500 hover:bg-yellow-600 text-black px-6 py-4 rounded-xl font-bold transition-all shadow-lg shadow-yellow-500/20">Approve</button>
                                <button onclick="updateDraftStatus(${d.id}, 'reject')" 
                                    class="w-full bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white border border-red-500/20 px-6 py-4 rounded-xl font-bold transition-all">Reject</button>
                            </div>
                        </div>
                    `).join('');
                }

                list.innerHTML = html;

            } catch (err) {
                console.error('Error loading pending items', err);
                list.innerHTML = '<div class="text-red-500">Error loading data.</div>';
            }
        }

        async function updateExtensionStatus(id, action) {
            let reason = '';
            if (action === 'reject' || action === 'action_required') {
                reason = prompt(`Enter ${action === 'reject' ? 'rejection' : 'feedback'} reason:`);
                if (reason === null) return;
            }

            try {
                const res = await fetch(`/api/admin/extensions/${id}/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                const data = await res.json();
                if (data.success) {
                    loadPending();
                    if (typeof loadAllExtensions === 'function') loadAllExtensions();
                } else {
                    alert(data.error || 'Update failed');
                }
            } catch (err) {
                alert('Action failed');
            }
        }

        async function updateVersionStatus(vid, action) {
            let reason = '';
            if (action === 'reject') {
                reason = prompt("Enter rejection reason:");
                if (reason === null) return;
            }
            try {
                const res = await fetch(`/api/admin/versions/${vid}/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                if (res.ok) loadPending();
                else alert('Update failed');
            } catch (err) {
                alert('Action failed');
            }
        }

        async function updateDraftStatus(did, action) {
            let reason = '';
            if (action === 'reject') {
                reason = prompt("Enter rejection reason:");
                if (reason === null) return;
            }
            try {
                const res = await fetch(`/api/admin/drafts/${did}/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                if (res.ok) {
                    loadPending();
                    if (typeof loadAllExtensions === 'function') loadAllExtensions();
                } else alert('Update failed');
            } catch (err) {
                alert('Action failed');
            }
        }

        async function loadAllExtensions() {
            const list = document.getElementById('all-extensions-list');
            if (!list) return;
            list.innerHTML = '<div class="text-gray-500 animate-pulse p-12 text-center font-bold">Loading global extension list...</div>';

            try {
                const res = await fetch('/api/admin/extensions/all');
                if (!res.ok) {
                    list.innerHTML = `<div class="bg-red-500/10 border border-red-500/20 p-12 rounded-2xl text-center text-red-500 font-bold">Failed to load extensions (Status: ${res.status})</div>`;
                    return;
                }
                const data = await res.json();
                allExtensions = Array.isArray(data) ? data : [];
                renderAllExtensions(allExtensions);
            } catch (err) {
                console.error('[MCLC] Error loading all extensions:', err);
                list.innerHTML = '<div class="bg-red-500/10 border border-red-500/20 p-12 rounded-2xl text-center text-red-500 font-bold">Network error loading extensions.</div>';
            }
        }

        function renderAllExtensions(extensions) {
            const list = document.getElementById('all-extensions-list');

            if (extensions.length === 0) {
                list.innerHTML = '<div class="bg-surface/30 border border-dashed border-white/5 p-12 rounded-2xl text-center text-gray-600 font-bold">No extensions found.</div>';
                return;
            }

            list.innerHTML = `
                <table class="w-full text-left border-separate border-spacing-y-4">
                    <thead>
                        <tr class="text-gray-500 text-sm uppercase tracking-widest">
                            <th class="px-6 py-2">Extension</th>
                            <th class="px-6 py-2">Type</th>
                            <th class="px-6 py-2">Developer</th>
                            <th class="px-6 py-2">Status</th>
                            <th class="px-6 py-2 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${extensions.map(ext => `
                            <tr class="bg-surface/50 hover:bg-surface border border-white/5 rounded-2xl transition-all group">
                                <td class="px-6 py-4 rounded-l-2xl">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 bg-white/5 rounded-lg flex items-center justify-center font-bold text-primary border border-white/5">
                                            ${ext.name.charAt(0)}
                                        </div>
                                        <div>
                                            <div class="font-bold text-white">${ext.name}</div>
                                            <div class="text-[10px] text-gray-500 font-mono tracking-tighter">${ext.identifier}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="text-[10px] font-bold uppercase tracking-wider text-gray-400 bg-white/5 px-2 py-1 rounded">${ext.type || 'extension'}</span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm font-semibold text-gray-300">${ext.developer}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded 
                                        ${ext.status === 'approved' ? 'bg-primary/20 text-primary' :
                    (ext.status === 'rejected' ? 'bg-red-500/20 text-red-500' :
                        (ext.status === 'action_required' ? 'bg-yellow-500/20 text-yellow-500' : 'bg-blue-500/20 text-blue-400'))}">
                                        ${ext.status === 'action_required' ? 'Action Required' : ext.status}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-right rounded-r-2xl">
                                    <div class="flex items-center justify-end gap-2 transition-all">
                                        <a href="dashboard.html?edit=${ext.id}" class="p-2 bg-primary/10 hover:bg-primary text-primary hover:text-black rounded-lg transition-all" title="Edit in Dashboard">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                        </a>
                                        <a href="/extensions/${ext.identifier}" target="_blank" class="p-2 bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white rounded-lg transition-all" title="View Page">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                        </a>
                                        <button onclick="deleteExtension(${ext.id})" class="p-2 bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white rounded-lg transition-all" title="Delete">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function filterExtensions() {
            const query = document.getElementById('admin-search').value.toLowerCase();
            const filtered = allExtensions.filter(e =>
                e.name.toLowerCase().includes(query) ||
                e.identifier.toLowerCase().includes(query) ||
                e.developer.toLowerCase().includes(query)
            );
            renderAllExtensions(filtered);
        }

        async function deleteExtension(id) {
            if (!confirm('Are you sure you want to PERMANENTLY delete this extension? This cannot be undone.')) return;
            try {
                const res = await fetch(`/api/admin/extensions/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    alert('Extension deleted.');
                    loadAllExtensions();
                }
            } catch (err) { alert('Delete failed.'); }
        }

        function promptReject(id) {
            const reason = prompt("Enter a reason for rejection (optional):");
            if (reason === null) return; // Cancelled
            updateStatus(id, 'reject', reason);
        }

        async function updateStatus(id, action, reason = '') {
            try {
                const res = await fetch(`/api/admin/extensions/${id}/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                const result = await res.json();
                if (result.success) {
                    alert(`Extension ${action}d!`);
                    loadPending();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Action failed.');
            }
        }

        loadPending();
    </script>
    <script src="main.js?v=4"></script>
</body>

</html>